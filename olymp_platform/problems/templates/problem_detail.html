{% extends "base.html" %}
{% block content %}

<div class="card">
  <h2>{{ problem.title }}</h2>
  <p>{{ problem.text }}</p>

  <div class="profile-box" style="display:flex; justify-content:space-between; align-items:center;">
    <div>‚è± –í—Ä–µ–º—è: <span id="timer">{{ result.time_spent|default:0 }}</span> —Å–µ–∫</div>
    <div style="opacity:.8;">–†–µ—à–∞–π üôÇ</div>
  </div>

  <br>

  {% if not answered %}
    <form method="post" action="{% url 'solve_problem' problem.pk %}" id="answerForm">
      {% csrf_token %}
      <input type="text" name="answer" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." required>
      <input type="hidden" name="time_spent" id="time_spent" value="0">
      <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button id="hintBtn" type="button">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É</button>
    </form>
  {% endif %}

  {% if problem.hint %}
    <div style="margin-top:10px;">

      <div id="hintBox" class="profile-box" style="display:none; margin-top:10px;">
        {{ problem.hint }}
      </div>
    </div>

    <script>
      (function(){
        const btn = document.getElementById("hintBtn");
        const box = document.getElementById("hintBox");
        if (!btn || !box) return;

        btn.addEventListener("click", () => {
          const open = box.style.display === "block";
          box.style.display = open ? "none" : "block";
          btn.textContent = open ? "–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É" : "–°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É";
        });
      })();
    </script>
  {% endif %}


  {% if result %}
    <div class="card" style="margin-top:20px;">
      {% if result.is_correct %}
        <h3 class="success">‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!</h3>
      {% else %}
        <h3 class="error">‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</h3>
        <p><b>–¢–≤–æ–π –æ—Ç–≤–µ—Ç:</b> {{ result.your_answer }}</p>
      {% endif %}
      <p><b>–í—Ä–µ–º—è —Ä–µ—à–µ–Ω–∏—è:</b> {{ result.time_spent }} —Å–µ–∫</p>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button type="button" id="toggleAnswerBtn">–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</button>

        <a href="{% url 'problem_detail' problem.pk %}">
          <button type="button">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>
        </a>
      </div>

      <div id="correctAnswerBox" class="profile-box" style="margin-top:12px; display:none;">
        ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <b>{{ result.correct_answer }}</b>
      </div>
    </div>
  {% endif %}
</div>

<script>
  const answered = {{ answered|yesno:"true,false" }};

  let seconds = 0;
  const timerEl = document.getElementById("timer");
  const timeInput = document.getElementById("time_spent");
  const form = document.getElementById("answerForm");

  let interval = null;

  if (!answered && timerEl && timeInput) {
    interval = setInterval(() => {
      seconds++;
      timerEl.textContent = seconds;
      timeInput.value = seconds;
    }, 1000);
  }

  if (form) {
    form.addEventListener("submit", () => {
      if (interval) clearInterval(interval);
      timeInput.value = seconds;
    });
  }

  const btn = document.getElementById("toggleAnswerBtn");
  const box = document.getElementById("correctAnswerBox");

  if (btn && box) {
    btn.addEventListener("click", () => {
      const opened = box.style.display === "block";
      box.style.display = opened ? "none" : "block";
      btn.textContent = opened ? "–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç" : "–°–∫—Ä—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç";
    });
  }
</script>

{% endblock %}
